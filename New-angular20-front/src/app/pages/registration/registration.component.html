<div class="registration-wrapper" [dir]="lang.dir()">
    <div class="container py-5 registration-container">
        <!-- Header -->
        <div class="d-flex align-items-center mb-4 text-white">
            <a class="btn btn-outline-light btn-sm rounded-pill shadow-sm me-3 fw-bold" routerLink="/landing">
                <i class="bi bi-arrow-left"></i> {{ lang.t().profile.actions.cancel }}
            </a>
            <h2 class="mb-0 fw-bold text-white text-shadow">{{ lang.t().registration.title }} <span
                    class="fw-light ms-2 text-white-50">/
                    {{ lang.currentLang() === 'fr' ? 'التسجيل' : 'Inscription' }}</span></h2>
        </div>

        <!-- Stepper -->
        <div class="glass-stepper position-relative mb-5 mx-2">
            <div class="progress position-absolute progress-container" style="height: 3px;">
                <div class="progress-bar bg-primary transition-width" role="progressbar"
                    [style.width.%]="((currentStep - 1) / 4) * 100"></div>
            </div>
            <div class="d-flex justify-content-between position-relative w-100">
                <button type="button" class="btn step-indicator d-flex align-items-center justify-content-center p-0"
                    [class.active]="currentStep === 1" [class.completed]="currentStep > 1">1</button>
                <button type="button" class="btn step-indicator d-flex align-items-center justify-content-center p-0"
                    [class.active]="currentStep === 2" [class.completed]="currentStep > 2">2</button>
                <button type="button" class="btn step-indicator d-flex align-items-center justify-content-center p-0"
                    [class.active]="currentStep === 3" [class.completed]="currentStep > 3">3</button>
                <button type="button" class="btn step-indicator d-flex align-items-center justify-content-center p-0"
                    [class.active]="currentStep === 4" [class.completed]="currentStep > 4">4</button>
                <button type="button" class="btn step-indicator d-flex align-items-center justify-content-center p-0"
                    [class.active]="currentStep === 5" [class.completed]="currentStep > 5">5</button>
            </div>
        </div>

        <!-- Form Card -->
        <div class="registration-card border-0 shadow-lg p-3 p-md-4 position-relative">
            <div class="card-body">
                <form [formGroup]="regForm" (ngSubmit)="onSubmit()">

                    <!-- STEP 1: BASIC INFO -->
                    <div *ngIf="currentStep === 1" class="animate-fade">
                        <h4 class="card-title fw-bold text-primary mb-4">
                            <i class="bi bi-person-vcard me-2"></i>{{ lang.t().registration.steps.personal }}
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">الاسم (Prénom Arabe)</label>
                                <input type="text" class="form-control" formControlName="prenomAr"
                                    [class.is-invalid]="regForm.get('prenomAr')?.invalid && regForm.get('prenomAr')?.touched">
                                <div *ngIf="regForm.get('prenomAr')?.hasError('required')" class="invalid-feedback">
                                    Champ
                                    obligatoire</div>
                                <div *ngIf="regForm.get('prenomAr')?.hasError('notArabic')" class="invalid-feedback">
                                    Texte
                                    en arabe uniquement</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">اللقب (Nom Arabe)</label>
                                <input type="text" class="form-control" formControlName="nomAr"
                                    [class.is-invalid]="regForm.get('nomAr')?.invalid && regForm.get('nomAr')?.touched">
                                <div *ngIf="regForm.get('nomAr')?.hasError('required')" class="invalid-feedback">Champ
                                    obligatoire</div>
                                <div *ngIf="regForm.get('nomAr')?.hasError('notArabic')" class="invalid-feedback">Texte
                                    en
                                    arabe uniquement</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ lang.t().profile.labels.cin }}</label>
                                <input type="text" class="form-control" formControlName="cin" maxlength="8"
                                    placeholder="00000000"
                                    [class.is-invalid]="regForm.get('cin')?.invalid && regForm.get('cin')?.touched">
                                <div class="invalid-feedback">CIN invalide (8 chiffres)</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Délivrée le (Date)</label>
                                <input type="date" class="form-control" formControlName="livreeLe">
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2: BIRTH DETAILS -->
                    <div *ngIf="currentStep === 2" class="animate-fade">
                        <h4 class="card-title fw-bold text-primary mb-4">
                            <i class="bi bi-file-earmark-text me-2"></i>{{ lang.t().registration.steps.birth }}
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Numéro d'inscription (عدد الرسم)</label>
                                <input type="text" class="form-control" formControlName="numInscription"
                                    (blur)="checkBirthDetails()"
                                    [class.is-invalid]="(regForm.get('numInscription')?.invalid && regForm.get('numInscription')?.touched) || !isBirthDetailsValid">
                                <div *ngIf="!isBirthDetailsValid" class="invalid-feedback">{{ birthDetailsErrorMsg }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Année de naissance</label>
                                <select class="form-select" formControlName="anneeNaissance"
                                    (change)="checkBirthDetails()">
                                    <option *ngFor="let y of years" [value]="y">{{y}}</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ lang.t().search.filters.gov }} (Naissance)</label>
                                <select class="form-select" formControlName="govBread" (change)="onBirthGovChange()">
                                    <option value="" disabled selected>-- Choisir --</option>
                                    <option *ngFor="let g of govs" [value]="g.id">{{ lang.currentLang() === 'ar' ?
                                        (g.libelle_Ar || g.libelle_Fr || g.libelle) : (g.libelle_Fr || g.libelle_Ar ||
                                        g.libelle) }}</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Municipalité</label>
                                <select class="form-select" formControlName="munBread" (change)="checkBirthDetails()">
                                    <option value="" disabled selected>-- Choisir --</option>
                                    <option *ngFor="let m of municipalitiesBirth" [value]="m.id">{{ lang.currentLang()
                                        === 'ar' ? (m.libelle_Ar || m.libelle_Fr || m.libelle) : (m.libelle_Fr ||
                                        m.libelle_Ar || m.libelle) }}
                                    </option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Extrait de Naissance (Scan)</label>
                                <input type="file" class="form-control" (change)="onFileChange($event)">
                                <div class="form-text">Format accepté: PDF, JPG, PNG (Max 2Mo)</div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 3: PERSONAL INFO -->
                    <div *ngIf="currentStep === 3" class="animate-fade">
                        <h4 class="card-title fw-bold text-primary mb-4">
                            <i class="bi bi-person-lines-fill me-2"></i>{{ lang.t().registration.steps.contact }}
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{{ lang.t().profile.labels.birthDate }}</label>
                                <input type="date" class="form-control" formControlName="dateNaissance"
                                    [class.is-invalid]="regForm.get('dateNaissance')?.invalid && regForm.get('dateNaissance')?.touched">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Genre</label>
                                <select class="form-select" formControlName="genre">
                                    <option value="male">Homme (ذكر)</option>
                                    <option value="female">Femme (أنثى)</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">{{ lang.t().profile.labels.address }}</label>
                                <input type="text" class="form-control" formControlName="adresse"
                                    [class.is-invalid]="regForm.get('adresse')?.invalid && regForm.get('adresse')?.touched">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Code Postal</label>
                                <input type="text" class="form-control" formControlName="codePostal" maxlength="4"
                                    [class.is-invalid]="regForm.get('codePostal')?.invalid && regForm.get('codePostal')?.touched">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">{{ lang.t().profile.labels.phone }} (Mobile)</label>
                                <input type="text" class="form-control" formControlName="telMobile" maxlength="8"
                                    [class.is-invalid]="regForm.get('telMobile')?.invalid && regForm.get('telMobile')?.touched">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">{{ lang.t().profile.labels.phone }} (Fixe)</label>
                                <input type="text" class="form-control" formControlName="telFixe" maxlength="8"
                                    [class.is-invalid]="regForm.get('telFixe')?.invalid && regForm.get('telFixe')?.touched">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">{{ lang.t().search.filters.gov }} (Adresse)</label>
                                <select class="form-select" formControlName="govAddress"
                                    (change)="onAddressGovChange()">
                                    <option *ngFor="let g of govs" [value]="g.id">{{ lang.currentLang() === 'ar' ?
                                        (g.libelle_Ar || g.libelle_Fr || g.libelle) : (g.libelle_Fr || g.libelle_Ar ||
                                        g.libelle) }}</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Délégation</label>
                                <select class="form-select" formControlName="delAddress">
                                    <option *ngFor="let d of delegations" [value]="d.id">{{ lang.currentLang() === 'ar'
                                        ? (d.libelle_Ar || d.libelle_Fr || d.libelle) : (d.libelle_Fr || d.libelle_Ar ||
                                        d.libelle) }}</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <hr class="my-3 text-muted">
                            </div>

                            <div class="col-md-12">
                                <label class="form-label">{{ lang.t().profile.labels.email }}</label>
                                <input type="email" class="form-control" formControlName="email" (blur)="checkEmail()"
                                    [class.is-invalid]="regForm.get('email')?.invalid && regForm.get('email')?.touched">
                                <div *ngIf="regForm.get('email')?.hasError('emailTaken')" class="invalid-feedback">Email
                                    déjà utilisé</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ lang.t().login.passwordLabel }}</label>
                                <input type="password" class="form-control" formControlName="password"
                                    [class.is-invalid]="regForm.get('password')?.invalid && regForm.get('password')?.touched">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ lang.t().login.passwordLabel }} (Confirmation)</label>
                                <input type="password" class="form-control" formControlName="confirmPassword"
                                    [class.is-invalid]="regForm.get('confirmPassword')?.invalid && regForm.get('confirmPassword')?.touched">
                                <div *ngIf="regForm.errors?.['mismatch']" class="invalid-feedback d-block">Mots de passe
                                    ne
                                    correspondent pas</div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 4: EDUCATION -->
                    <div *ngIf="currentStep === 4" class="animate-fade">
                        <h4 class="card-title fw-bold text-primary mb-4">
                            <i class="bi bi-mortarboard me-2"></i>{{ lang.t().registration.steps.education }}
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{{ lang.t().search.filters.level }}</label>
                                <select class="form-select" formControlName="niveauScolaire"
                                    [class.is-invalid]="regForm.get('niveauScolaire')?.invalid && regForm.get('niveauScolaire')?.touched">
                                    <option *ngFor="let n of niveaux" [value]="n.id">{{ lang.currentLang() === 'ar' ?
                                        (n.libelle_Ar || n.libelle_Fr || n.libelle) : (n.libelle_Fr || n.libelle_Ar ||
                                        n.libelle) }}</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Etablissement</label>
                                <input type="text" class="form-control" formControlName="etablissement"
                                    [class.is-invalid]="regForm.get('etablissement')?.invalid && regForm.get('etablissement')?.touched">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Type Etablissement</label>
                                <select class="form-select" formControlName="typeEtablissement">
                                    <option value="public">Public</option>
                                    <option value="prive">Privé</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Année Abandon</label>
                                <input type="number" class="form-control" formControlName="anneeAbandon"
                                    [class.is-invalid]="regForm.get('anneeAbandon')?.invalid && regForm.get('anneeAbandon')?.touched">
                            </div>
                        </div>

                        <div class="form-check form-switch mt-4 p-3 bg-light rounded">
                            <input class="form-check-input ms-0 me-2" type="checkbox"
                                formControlName="hasPreviousTraining" id="prevTrainingCheck">
                            <label class="form-check-label fw-medium" for="prevTrainingCheck">
                                J'ai déjà suivi une formation professionnelle (Previous Training)
                            </label>
                        </div>
                    </div>

                    <!-- STEP 5: PREVIOUS TRAINING -->
                    <div *ngIf="currentStep === 5" class="animate-fade">
                        <h4 class="card-title fw-bold text-primary mb-4">
                            <i class="bi bi-tools me-2"></i>التكوين المهني السابق
                        </h4>

                        <div class="alert alert-info border-0 shadow-sm"
                            *ngIf="!regForm.get('hasPreviousTraining')?.value">
                            <i class="bi bi-info-circle me-2"></i>
                            Vous n'avez pas coché "Formation précédente". Vous pouvez confirmer votre inscription.
                        </div>

                        <div class="row g-3" [class.opacity-50]="!regForm.get('hasPreviousTraining')?.value"
                            [style.pointer-events]="!regForm.get('hasPreviousTraining')?.value ? 'none' : 'auto'">
                            <div class="col-md-6">
                                <label class="form-label">Diplôme Obtenu</label>
                                <select class="form-select" formControlName="prevDiplome" (change)="onDiplomeChange()">
                                    <option *ngFor="let d of diplomes" [value]="d.id">{{ lang.currentLang() === 'ar' ?
                                        (d.libelle_Ar || d.libelle_Fr || d.libelle) : (d.libelle_Fr || d.libelle_Ar ||
                                        d.libelle) }}</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Spécialité</label>
                                <select class="form-select" formControlName="prevSpecialite"
                                    (change)="onPrevSpecialityChange()">
                                    <option *ngFor="let s of specialites" [value]="s.id">{{ lang.currentLang() === 'ar'
                                        ? (s.libelle_Ar || s.libelle_Fr || s.libelle) : (s.libelle_Fr || s.libelle_Ar ||
                                        s.libelle) }}</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ lang.t().search.filters.center }}</label>
                                <select class="form-select" formControlName="prevCentre">
                                    <option *ngFor="let c of centres" [value]="c.id">{{ lang.currentLang() === 'ar' ?
                                        (c.libelle_Ar || c.libelle_Fr || c.libelle) : (c.libelle_Fr || c.libelle_Ar ||
                                        c.libelle) }}</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Année de Fin</label>
                                <input type="text" class="form-control" formControlName="prevAnneeFin">
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="d-flex justify-content-between mt-5 pt-3 border-top">
                        <button type="button" class="btn btn-outline-secondary px-4 rounded-pill fw-bold"
                            *ngIf="currentStep > 1" (click)="prevStep()">
                            <i class="bi bi-arrow-left me-2"></i> {{ lang.t().registration.buttons.prev }}
                        </button>
                        <div class="ms-auto"> <!-- Spacer --> </div>

                        <button type="button" class="btn btn-primary px-4 rounded-pill fw-bold shadow-sm"
                            *ngIf="currentStep < 5" (click)="nextStep()">
                            {{ lang.t().registration.buttons.next }} <i class="bi bi-arrow-right ms-2"></i>
                        </button>

                        <button type="submit" class="btn btn-secondary px-5 rounded-pill fw-bold shadow-sm"
                            *ngIf="currentStep === 5" [disabled]="isLoading">
                            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                            {{ isLoading ? 'Traitement...' : lang.t().registration.buttons.submit }}
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>