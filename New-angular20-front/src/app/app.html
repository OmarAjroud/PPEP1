<nav class="navbar navbar-expand-lg navbar-light fixed-top glass-navbar" [dir]="lang.dir()">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" routerLink="/landing">
            <img src="/assets/images/atfp.png" alt="ATFP Logo" height="40" class="d-inline-block align-text-top me-2">
        </a>

        <!-- Mobile Toggler & Language Switcher (Mobile) -->
        <div class="d-flex align-items-center gap-2 d-lg-none">
            <button class="btn btn-sm btn-outline-primary rounded-pill px-3 fw-bold" (click)="lang.toggleLanguage()">
                {{ lang.currentLang() === 'fr' ? 'ðŸ‡¹ðŸ‡³ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'ðŸ‡«ðŸ‡· FR' }}
            </button>
            <button class="navbar-toggler" type="button" (click)="toggleMenu()">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>

        <div class="collapse navbar-collapse justify-content-end" [class.show]="!isMenuCollapsed()" id="navbarNav">
            <ul class="navbar-nav gap-3 align-items-center">
                <!-- Protected Nav Items (Visible but Guarded) -->
                <li class="nav-item">
                    <a class="nav-link fw-bold" routerLink="/home" routerLinkActive="active text-primary"
                        (click)="isMenuCollapsed.set(true)">
                        {{ lang.t().nav.home }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fw-bold" routerLink="/about" routerLinkActive="active text-primary"
                        (click)="isMenuCollapsed.set(true)">
                        {{ lang.t().nav.about }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fw-bold" routerLink="/search" routerLinkActive="active text-primary"
                        (click)="isMenuCollapsed.set(true)">
                        {{ lang.t().nav.search }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fw-bold" routerLink="/offre" routerLinkActive="active text-primary"
                        (click)="isMenuCollapsed.set(true)">
                        {{ lang.t().nav.applications }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fw-bold" routerLink="/details" routerLinkActive="active text-primary"
                        (click)="isMenuCollapsed.set(true)">
                        {{ lang.t().nav.profile }}
                    </a>
                </li>

                <!-- Language Switcher (Desktop) -->
                <li class="nav-item d-none d-lg-block ms-2">
                    <button class="btn btn-outline-primary rounded-pill px-3 fw-bold transition-all hover-scale"
                        (click)="lang.toggleLanguage()">
                        {{ lang.currentLang() === 'fr' ? 'ðŸ‡¹ðŸ‡³ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'ðŸ‡«ðŸ‡· FranÃ§ais' }}
                    </button>
                </li>

                <!-- Auth State -->
                <li class="nav-item ms-lg-2" *ngIf="!api.isAuthenticated()">
                    <a class="btn btn-primary px-4 rounded-pill shadow-sm" routerLink="/login"
                        (click)="isMenuCollapsed.set(true)">
                        {{ lang.t().nav.login }}
                    </a>
                </li>

                <li class="nav-item dropdown ms-lg-2" *ngIf="api.isAuthenticated()">
                    <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="javascript:void(0)"
                        role="button" (click)="toggleDropdown()" [class.show]="isDropdownOpen()">
                        <!-- While profile is loading, show neutral icon -->
                        <ng-container *ngIf="!api.currentUser()">
                            <div class="rounded-circle border border-2 border-white shadow-sm d-flex align-items-center justify-content-center"
                                style="width: 40px; height: 40px; background-color: #e9ecef;">
                                <i class="bi bi-person text-muted"></i>
                            </div>
                            <span class="fw-bold text-muted d-none d-lg-block">
                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            </span>
                        </ng-container>
                        <!-- Once profile is loaded, show correct avatar and name -->
                        <ng-container *ngIf="api.currentUser()">
                            <img [src]="'/assets/images/' + (api.currentUser()?.donnee?.Genre === 'female' ? 'userf.png' : 'user.png')"
                                alt="Profile"
                                class="rounded-circle border border-2 border-white shadow-sm object-fit-cover"
                                style="width: 40px; height: 40px; background-color: #e9ecef;">
                            <span class="fw-bold text-dark d-none d-lg-block">
                                {{api.currentUser()?.credential?.prenomAr}} {{api.currentUser()?.credential?.nomAr}}
                            </span>
                        </ng-container>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0" [class.show]="isDropdownOpen()">
                        <li><a class="dropdown-item" routerLink="/details"
                                (click)="isDropdownOpen.set(false); isMenuCollapsed.set(true)"><i
                                    class="bi bi-person-gear me-2"></i>
                                {{ lang.t().nav.profile }}
                            </a></li>
                        <li *ngIf="api.isAdmin()"><a class="dropdown-item" routerLink="/admin"
                                (click)="isDropdownOpen.set(false); isMenuCollapsed.set(true)">
                                <i class="bi bi-shield-lock me-2 text-primary"></i>
                                {{ lang.t().admin.nav.dashboard }}
                            </a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><button class="dropdown-item text-danger" (click)="logout()">
                                <i class="bi bi-box-arrow-right me-2"></i>{{ lang.t().nav.logout }}
                            </button></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid p-0 main-content">
    <router-outlet></router-outlet>
</div>